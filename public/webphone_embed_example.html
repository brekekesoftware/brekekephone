<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Brekeke Phone Component Example</title>

    <style>
      #web_phone_embed_div {
        /* must display flex */
        display: flex;
        /* others are customizable */
        position: fixed;
        top: 0;
        bottom: 0;
        left: 0;
        width: 400px;
      }
      .brekeke_phone_component_hidden {
        visibility: hidden;
        pointer-events: none;
      }
    </style>
  </head>

  <body>
    <div id="web_phone_embed_div"></div>
  </body>

  <!-- here we can globally configure some property
      need to inject this snippet BEFORE webphone.js -->
  <script type="text/javascript">
    window._BrekekePhoneCaptureConsole = true
  </script>
  <script type="text/javascript" src="./webphone.js"></script>

  <!-- here the actual code to use the embed webphone.js -->
  <script type="text/javascript">
    // we need to create div in our html code and get it
    var div = document.getElementById('web_phone_embed_div')

    // init a new Brekeke Phone instance to use
    var phone = window.Brekeke.Phone.render(div, {
      // login automatically with the account, the first one in the account you specify below
      // or when accounts are not specified here and you have existing accounts, login to the last recently used
      auto_login: true,
      // clear all the existing accounts, default false
      // the accounts are stored in the localStorage
      // if false, the accounts will overwrite the duplicated entries (host, port, tenant, user)
      clear_existing_accounts: false,
      // hostname:              string
      // port:                  string
      // tenant:                string - optional
      // username:              string
      // password:              string
      // phoneIndex:            number 1-4 - optional - default 4
      // uc:                    boolean - optional - default false
      // ucDisplayOfflineUsers: boolean - optional - default false
      // parks:                 string[] - optional
      // parkNames:             string[] - optional
      // pushNotification:      boolean - optional - default false
      accounts: [
        {
          hostname: 'YOUR_PBX_HOSTNAME',
          port: 'YOUR_PBX_PORT',
          tenant: 'TENANT',
          username: 'USERNAME',
          password: 'PASSWORD',
        },
      ],
      // pal params
      'webphone.pal.param.user': 'user1,user2,user3',
      'webphone.pal.param.line': 'line1,line2,line3',
      'webphone.pal.param.xxxx': 'yyyy',
    })

    // MULTIPLE INSTANCES WILL NOT WORK
    // THIS IS NOT SUPPORTED YET
    var phone1 = window.Brekeke.Phone.render(div1, opt1)
    var phone2 = window.Brekeke.Phone.render(div2, opt2)

    // prompt for permission if needed
    phone.promptBrowserPermission()

    // show/hide the instance via the div, using above css in <style> tag
    div.classList.remove('brekeke_phone_component_hidden')
    div.classList.add('brekeke_phone_component_hidden')

    phone.on('call', c => {
      console.log('phone.on.call', c.id, c.incoming)
      console.log(c) // console log to see all details
      // here you manually can show the UI
      div.classList.remove('brekeke_phone_component_hidden')
      // access to the raw session to get more data
      c.rawSession.incomingMessage.getHeader('X-PBX-Session-Info')
    })
    phone.on('call_update', c => {
      console.log('phone.on.call_update', c.id) // identify by the same above id
      console.log(c) // all fields same with above
      // access to the raw session to get more data
      c.rawSession.incomingMessage.getHeader('X-PBX-Session-Info')
    })
    phone.on('call_end', c => {
      console.log('phone.on.call_end', c.id) // identify by the same above id
      // here you can manually hide the UI if no running call
      if (!phone.getRunningCalls().length) {
        div.classList.add('brekeke_phone_component_hidden')
      }
      // access to the raw session to get more data
      c.rawSession.incomingMessage.getHeader('X-PBX-Session-Info')
    })

    // get the raw pal instance from pbx
    // when account login, it will construct the pal and you can access via this event
    // IMPORTANT NOTE: this event can fire multiple times if retry on login failed or pal params change
    phone.on('pal', async pal => {
      // account fields can be found github Brekeke Phone src/stores/accountStore.ts
      var currentAccount = phone.getCurrentAccount()
      console.log('phone.on.pal currentAccount:', currentAccount.pbxUsername)
      // pal is from window.Brekeke.pbx.getPal
      // console log to see all details
      console.log('phone.on.pal', pal)
      // here you can listen on events like: notify_status...
      // IMPORTANT NOTE: you need to keep the current listener so it wont be overrided
      var old_notify_status = pal.notify_status
      pal.notify_status = e => {
        old_notify_status && old_notify_status(e) // call old listener
        console.log(e.status, e.user, e.talker_id)
      }
      // you can call pal method here using promise:
      var res = await pal.call_pal('name', options)
    })

    // get the raw instance from webrtcclient.js
    // when account login, it will construct the client and you can access via this event
    phone.on('webrtcclient', async client => {
      // client is an instance of window.Brekeke.WebrtcClient.Phone
      // console log to see all details
      console.log('phone.on.webrtcclient', client)
      // here you can access to inner sip object:
      console.log(client._ua)
    })

    // make outgoing call
    // the new call will be notified via above event phone.on('call', ...)
    var options = {
      extraHeaders: ['X-Foo: foo', 'X-Bar: bar'],
    }
    var withVideo = true
    phone.call('number', options, withVideo)

    // restart the instance, it will logout the current account if any, and relogin with the new option
    // same opt shape from window.Brekeke.Phone.render(div, opt)
    phone.restart(opt)

    // cleanup the instance, it will logout the current account if any, and unmount all the dom nodes from the div
    phone.cleanup()

    // attach to window so we can test in devtool
    window._brekeke_phone = phone
  </script>
</html>
